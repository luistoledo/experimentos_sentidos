<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.37/Tone.js" integrity="sha512-gK8OnTXn8cTYkHqYX+bhzjQ1rClAPuG2eMy+oRuV26mSuE0EbZeULFKdyc/YGX1Z/JsC06FXxQttdX4aahjSMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <title>autopong</title>
    </head>
    <body>
        <button id="start">start</button>
        <button id="stop">stop</button>
        <div class="slidecontainer">
          <input type="range" min="1" max="500" value="3" class="slider" id="rango" disabled>
          <input type="range" min="1" max="500" value="3" class="slider" id="rango2" disabled>
          <input type="range" min="1" max="5000" value="1000" class="slider" id="rango3">
        </div>
        <canvas id="circulo" width=700 height=700></canvas>
        <script>
            let variable=100;
            let variable2=100;
            let variable3=1000;
            let note;
            let canvas = document.getElementById("circulo")
            let ctx = canvas.getContext("2d")
            let interval;
            let i = 10;
            let x, y, dx, dy;
            let bgColors = ["rgba(200,50,200,.03)", "rgba(20,250,200,.03)", "rgba(20,50,10,.03)", "rgba(230,150,20,.03)", "rgba(50,50,200,.03)"]
            let bgColorIndex = 0
            let synthNotes = ["F", "D", "A"]
            let synthChords = [ ["C", "E", "G"] , ["F", "D", "A"], ["C","D","F"] ]
            let synthNoteIndex = 0
            let automata = null //interval para automatizaci√≥n del todo

            function init(){
                dx = 5 - (Math.random() * 10)
                dy = 5 - (Math.random() * 10)
                //solo por seguridad que tenga un valor operable
                if (dx<1 && dx>-1) dx=1
                if (dy<1 && dy>-1) dy=1
                x=Math.random()*canvas.offsetWidth; y=Math.random()*100

                automata = setInterval(()=>{ 
                    slider.value = Math.random()*800
                    slider2.value = Math.random()*800
                    variable = slider.value
                    variable2 = slider2.value
                }, variable3)
            }
            function windChanged() {
                bgColorIndex++
                synthNoteIndex++
                chorus.depth     = Math.random()*0.9
                chorus.delayTime = Math.random()*2.5
                if (bgColorIndex >= bgColors.length) bgColorIndex=0
                if (synthNoteIndex >= synthNotes.length) synthNoteIndex=0
            }
            function draw() {
                ctx.fillStyle = bgColors[bgColorIndex]
                if (i % 10 < 0.5) ctx.fillRect(0, 0, canvas.width, canvas.height); 

                ctx.fillStyle = `rgba(${variable2/5},100,${variable/10},0.9)`;
                sw = (variable/14) + 3
                sh = (variable2/14) + 3 
                x += dx
                y += dy
                
                if (x+sw > canvas.offsetWidth || x < 0) { 
                    dx *= -1
                    windChanged()
                }
                if (y+sh > canvas.offsetHeight || y < 0) {
                    dy *= -1
                    windChanged()
                }

                
                ctx.fillRect(x, y, sw, sh)

                const newNote = `${synthNotes[synthNoteIndex]}${variable2/100}`
                const newChord = [  `${synthChords[synthNoteIndex][0]}${variable2/100}`,
                                    `${synthChords[synthNoteIndex][1]}${variable2/100}`,
                                    `${synthChords[synthNoteIndex][2]}${variable2/100}`]

                // if (i % (variable2/50) < 0.5) synth.triggerAttackRelease(`${synthNotes[synthNoteIndex]}${variable2/100}`, variable/50);
                if (i % 10 < 0.5) {
                    // synth.triggerAttackRelease(newNote, variable/50);
                    psynth.triggerAttackRelease(newNote, variable/50);
                }
                // console.log("starting with ", newNote);
                // osc.start();
                i++
            }

            var slider = document.getElementById("rango");
            slider.oninput = function() {
              variable = this.value;
            } 
            
            var slider2 = document.getElementById("rango2");
            slider2.oninput = function() {
                variable2 = this.value;
            }
            var slider3 = document.getElementById("rango3");
            slider3.oninput = function() {
                variable3 = this.value;
            }
            // const osc = new Tone.Oscillator("D4").toDestination();//.start().toDestination();
            const synth = new Tone.MembraneSynth().toDestination()
            const chorus = new Tone.Chorus(4, 2.5, 0.5).toDestination().start()
            const psynth = new Tone.PolySynth().connect(chorus)


            document.getElementById('start')?.addEventListener('click', async () => {
                init()
                interval = setInterval(draw,100)
                slider3.disabled = true
            } )
            document.getElementById('stop')?.addEventListener('click', async () => {
                // osc.stop(0)
                clearInterval(interval)
                clearInterval(automata)
                slider3.disabled = false
            } )
        </script>
    </body>
</html>
